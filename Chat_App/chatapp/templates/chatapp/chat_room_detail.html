<!DOCTYPE html>
<html>
  <head>
    <title>{{ chat_room.name }}</title>
    {% load static %}
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{% static 'chatapp/style.css' %}" />
  </head>
  <body>
    <h3>ChatApp</h3>
    <h1>Welcome, {{ user.username }}!</h1>
    <h2>This is Chat room: {{ chat_room.name }}</h2>

    <p><a href="{% url 'chat_room_list' %}">‚Üê Back to Chat Rooms</a></p>

    <div id="messages">
      {% for message in messages %}
      <div
        class="message {% if message.sender == request.user %}outgoing{% else %}incoming{% endif %}"
        id="message-{{ message.id }}"
      >
        <strong>{{ message.sender.username }}:</strong> {{ message.content }}
        <br />
        <small class="delivered">
          {% if message.is_delivered %}Delivered &#10003;{% else %}Pending...{% endif %}
        </small>
        <small class="read">
          {% if message.is_read %}Read &#10003;&#10003;{% endif %}
        </small>
      </div>
      {% endfor %}
    </div>

    <form id="message-form">
      {% csrf_token %}
      <input
        type="text"
        id="message-content"
        placeholder="Type your message..."
      />
      <button type="submit">Send</button>
    </form>

    <script>
      document
        .getElementById("message-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const content = document.getElementById("message-content").value;
          fetch('{% url "send_message" chat_room.name %}', {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": document.querySelector(
                "[name=csrfmiddlewaretoken]"
              ).value,
            },
            body: `content=${encodeURIComponent(content)}`,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "success") {
                document.getElementById("message-content").value = "";
                location.reload();
              }
            });

          messages.forEach((messageDiv) => {
            const messageId = messageDiv.id.split("-")[1];
            if (
              !messageDiv
                .querySelector(".read")
                .innerText.includes("&#10003;&#10003;")
            ) {
              fetch(`/chat/message/${messageId}/read/`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
                  "X-CSRFToken": document.querySelector(
                    "[name=csrfmiddlewaretoken]"
                  ).value,
                },
                body: "",
              })
                .then((response) => {
                  if (!response.ok) {
                    return response.text().then((text) => {
                      console.error("Django Error Response:", text);
                      throw new Error(`HTTP error! status: ${response.status}`);
                    });
                  }
                  return response.json();
                })
                .then((data) => {
                  if (data.status === "success") {
                    const readSpan = messageDiv.querySelector(".read");
                    if (readSpan) {
                      readSpan.innerHTML = "Read &#10003;&#10003;";
                      console.log(`Message ${messageId} marked as read.`);
                    }
                  }
                })
                .catch((error) =>
                  console.error("Error marking message read:", error)
                );
            }
          });
        });
    </script>
  </body>
</html>
